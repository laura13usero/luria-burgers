<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order details</title>
  <link rel="stylesheet" href="css/resumencompra.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Ibarra+Real+Nova&display=swap" rel="stylesheet">
  <script src="https://www.paypal.com/sdk/js?client-id=AaDAT1lIR-rPp2H1RFiSd9xPbD1me0OvaZQy3WzYN2Bh5P2xsp9MqAKd1hApRESxjdRM5zuvc-_zrkqA&currency=EUR"></script>
</head>
<body>

<div class="ticket">

  <div id="contenido-resumen">
    <p>Loading order details...</p>
  </div>

  <div id="paypal-button-container" style="margin-top: 20px;"></div>

  <button onclick="window.location.href = 'carrito.html'" style="margin-top: 20px;">Back to cart</button>
</div>

<script>
  async function cargarResumenCompra() {
      try {
          const response = await fetch('/webapp-1.0-SNAPSHOT/control?action=getResumenCompra');
          if (!response.ok) throw new Error('Failed in loading cart details.');

          const data = await response.json();
          const contenedor = document.getElementById('contenido-resumen');

          if (!data.carrito || data.carrito.length === 0) {
              contenedor.innerHTML = '<p>Your cart is empty.</p>';
              return;
          }

          // Crear tabla de productos
          let tablaHTML = `
              <table border="1" cellpadding="5">
                  <tr><th>Producto</th><th>Price</th></tr>
          `;

          data.carrito.forEach(producto => {
              tablaHTML += `
                  <tr>
                      <td>${producto.nombre}</td>
                      <td>$${producto.precio.toFixed(2)}</td>
                  </tr>
              `;
          });

          tablaHTML += `
              <tr>
                  <td><strong>Total</strong></td>
                  <td><strong>$${data.total.toFixed(2)}</strong></td>
              </tr>
              </table>
          `;

          contenedor.innerHTML = tablaHTML;

          // Generar botón PayPal dinámicamente con el total
          paypal.Buttons({
              createOrder: function (dataPaypal, actions) {
                  return actions.order.create({
                      purchase_units: [{
                          amount: {
                              value: data.total.toFixed(2)
                          }
                      }]
                  });
              },
              onApprove: function (dataPaypal, actions) {
                  return actions.order.capture().then(function (details) {
                      alert('Pago completado por ' + details.payer.name.given_name);
                      // Redirigir al backend para finalizar la compra
                      window.location.href = '/webapp-1.0-SNAPSHOT/control?action=finalizarCompra';
                  });
              }
          }).render('#paypal-button-container');

      } catch (error) {
          console.error('Failed loading cart details:', error);
          document.getElementById('contenido-resumen').innerHTML = '<p>Failed loading cart details.</p>';
      }
  }

  document.addEventListener('DOMContentLoaded', cargarResumenCompra);
</script>

</body>
</html>